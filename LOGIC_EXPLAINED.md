# üéØ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏—è –º—è—á–∞

## –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏

**–ö–∞–º–µ—Ä–∞:** –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∞ **–∑–∞ —Ñ—É—Ç–±–æ–ª—å–Ω—ã–º–∏ –≤–æ—Ä–æ—Ç–∞–º–∏** –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ ~2 –º–µ—Ç—Ä–∞

**–ó–∞–¥–∞—á–∞:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º—è—á:
- **–ü–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π** (–Ω–µ –∑–∞–ª–µ—Ç–µ–ª –≤ –≤–æ—Ä–æ—Ç–∞) = –±–ª–∏–∂–µ –∫ –∫–∞–º–µ—Ä–µ
- **–ó–∞ —Å–µ—Ç–∫–æ–π** (–∑–∞–ª–µ—Ç–µ–ª –≤ –≤–æ—Ä–æ—Ç–∞) = –¥–∞–ª—å—à–µ –æ—Ç –∫–∞–º–µ—Ä—ã

## –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø

–ò–∑-–∑–∞ **–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã** –æ–±—ä–µ–∫—Ç—ã –¥–∞–ª—å—à–µ –æ—Ç –∫–∞–º–µ—Ä—ã –≤—ã–≥–ª—è–¥—è—Ç **–º–µ–Ω—å—à–µ**.

```
–ö–∞–º–µ—Ä–∞ ‚Üê 2–º ‚Üí –°–µ—Ç–∫–∞ –≤–æ—Ä–æ—Ç ‚Üê ~2–º ‚Üí –î–∞–ª—å–Ω—è—è —á–∞—Å—Ç—å –≤–æ—Ä–æ—Ç

[–ö–∞–º–µ—Ä–∞]  ‚Üí  [–ú—è—á –ë–û–õ–¨–®–û–ô]  ‚Üí  [–°–µ—Ç–∫–∞]  ‚Üí  [–ú—è—á –º–∞–ª–µ–Ω—å–∫–∏–π]
             –ü–ï–†–ï–î –°–ï–¢–ö–û–ô              –ó–ê –°–ï–¢–ö–û–ô
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

### 1Ô∏è‚É£ –†–∞–∑–º–µ—Ä –º—è—á–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç–æ—Ä, –≤–µ—Å: 50%)

**–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: **22.5 px** (–∑–∞ —Å–µ—Ç–∫–æ–π)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: **72 px** (–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π)
- –ú–µ–¥–∏–∞–Ω–∞: **31.8 px**

**–ü–æ—Ä–æ–≥–∏:**
```python
size_threshold_far = 28   # –ï—Å–ª–∏ –º–µ–Ω—å—à–µ ‚Üí —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ó–ê —Å–µ—Ç–∫–æ–π
size_threshold_near = 48  # –ï—Å–ª–∏ –±–æ–ª—å—à–µ ‚Üí —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ü–ï–†–ï–î —Å–µ—Ç–∫–æ–π
```

**–õ–æ–≥–∏–∫–∞:**
- **–î–∏–∞–º–µ—Ç—Ä < 28 px** ‚Üí –ú—è—á **–∑–∞ —Å–µ—Ç–∫–æ–π** (–¥–∞–ª—å—à–µ, –º–µ–Ω—å—à–µ)
- **–î–∏–∞–º–µ—Ç—Ä > 48 px** ‚Üí –ú—è—á **–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π** (–±–ª–∏–∂–µ, –±–æ–ª—å—à–µ)
- **28-48 px** ‚Üí –ê–Ω–∞–ª–∏–∑ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º

### 2Ô∏è‚É£ Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ (–≤–µ—Å: 15-20%)

**–ù–∞–±–ª—é–¥–µ–Ω–∏–µ:** –ú—è—á–∏ –∑–∞ —Å–µ—Ç–∫–æ–π —á–∞—Å—Ç–æ –≤ –≤–µ—Ä—Ö–Ω–µ–π/—Å—Ä–µ–¥–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞–¥—Ä–∞

```python
y_threshold_high = 0.4  # 40% –≤—ã—Å–æ—Ç—ã –∫–∞–¥—Ä–∞ —Å–≤–µ—Ä—Ö—É
```

**–õ–æ–≥–∏–∫–∞:**
- **Y < 0.4** ‚Üí +0.2 –∫ –±–∞–ª–ª–∞–º "–∑–∞ —Å–µ—Ç–∫–æ–π"
- **Y > 0.4** ‚Üí +0.15 –∫ –±–∞–ª–ª–∞–º "–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π"

### 3Ô∏è‚É£ –û–∫–∫–ª—é–∑–∏—è —Å–µ—Ç–∫–æ–π (–≤–µ—Å: 10-30%)

–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç—É—Ä—ã –≤–æ–∫—Ä—É–≥ –º—è—á–∞:
- –ú–Ω–æ–≥–æ –ª–∏–Ω–∏–π/—Ä–µ–±–µ—Ä ‚Üí —Å–µ—Ç–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –º—è—á ‚Üí **–∑–∞ —Å–µ—Ç–∫–æ–π**
- –ú–∞–ª–æ –ª–∏–Ω–∏–π ‚Üí —Å–µ—Ç–∫–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç ‚Üí **–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π**

**–ú–µ—Ç–æ–¥:** –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ–±–µ—Ä Canny –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –º—è—á–∞

```python
if occlusion_score > 0.3:
    # –°–∏–ª—å–Ω–∞—è –æ–∫–∫–ª—é–∑–∏—è
    scores['behind'] += 0.3 * occlusion_score
else:
    # –°–ª–∞–±–∞—è –æ–∫–∫–ª—é–∑–∏—è
    scores['front'] += 0.1
```

## –ê–ª–≥–æ—Ä–∏—Ç–º

```python
def analyze_position(ball):
    scores = {'behind': 0.0, 'front': 0.0}
    
    # 1. –†–∞–∑–º–µ—Ä –º—è—á–∞ (–≥–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π)
    ball_diameter = (ball_width + ball_height) / 2
    
    if ball_diameter < 28:
        scores['behind'] += 0.5  # –ú–∞–ª–µ–Ω—å–∫–∏–π ‚Üí –∑–∞ —Å–µ—Ç–∫–æ–π
    elif ball_diameter > 48:
        scores['front'] += 0.5   # –ë–æ–ª—å—à–æ–π ‚Üí –ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π
    else:
        # –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
        ratio = (ball_diameter - 28) / (48 - 28)
        scores['front'] += ratio * 0.3
        scores['behind'] += (1 - ratio) * 0.3
    
    # 2. Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
    if normalized_y < 0.4:
        scores['behind'] += 0.2  # –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å ‚Üí –∑–∞ —Å–µ—Ç–∫–æ–π
    else:
        scores['front'] += 0.15  # –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å ‚Üí –ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π
    
    # 3. –û–∫–∫–ª—é–∑–∏—è —Å–µ—Ç–∫–æ–π
    if occlusion_score > 0.3:
        scores['behind'] += 0.3 * occlusion_score
    else:
        scores['front'] += 0.1
    
    # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
    if scores['behind'] > scores['front']:
        return "–ó–∞ —Å–µ—Ç–∫–æ–π"
    else:
        return "–ü–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π"
```

## –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –Ø–≤–Ω–æ –∑–∞ —Å–µ—Ç–∫–æ–π
```
–†–∞–∑–º–µ—Ä: 22.5 px (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π)
Y: 0.48 (–≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å)
–û–∫–∫–ª—é–∑–∏—è: 0.2

–ë–∞–ª–ª—ã:
  behind: 0.5 (—Ä–∞–∑–º–µ—Ä) + 0.2 (Y) = 0.7
  front: 0.1 (–æ–∫–∫–ª—é–∑–∏—è) = 0.1
  
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ó–ê –°–ï–¢–ö–û–ô ‚úì (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 85%)
```

### –ü—Ä–∏–º–µ—Ä 2: –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π
```
–†–∞–∑–º–µ—Ä: 60.5 px (–±–æ–ª—å—à–æ–π)
Y: 0.02 (–æ—á–µ–Ω—å –Ω–∏–∑–∫–æ)
–û–∫–∫–ª—é–∑–∏—è: 0.1

–ë–∞–ª–ª—ã:
  behind: 0.0
  front: 0.5 (—Ä–∞–∑–º–µ—Ä) + 0.15 (Y) + 0.1 (–æ–∫–∫–ª—é–∑–∏—è) = 0.75
  
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–ï–†–ï–î –°–ï–¢–ö–û–ô ‚úì (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 85%)
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª—É—á–∞–π
```
–†–∞–∑–º–µ—Ä: 30.0 px (–º–µ–∂–¥—É –ø–æ—Ä–æ–≥–∞–º–∏)
Y: 0.63 (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å)
–û–∫–∫–ª—é–∑–∏—è: 0.15

–ë–∞–ª–ª—ã:
  behind: 0.24 (—Ä–∞–∑–º–µ—Ä –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)
  front: 0.06 (—Ä–∞–∑–º–µ—Ä) + 0.15 (Y) + 0.1 (–æ–∫–∫–ª—é–∑–∏—è) = 0.31
  
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–ï–†–ï–î –°–ï–¢–ö–û–ô (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 53%)
```

## –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–æ–≤

–î–ª—è –≤–∞—à–µ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```bash
.venv/bin/python calibrate_thresholds.py \
    --images datasets/merged_ball_dataset/images/test \
    --confidence 0.4
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –º—è—á–µ–π
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏
- –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—É

## –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Ç–æ—á–Ω—ã, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

### 1. –ü–æ—Ä–æ–≥–∏ —Ä–∞–∑–º–µ—Ä–∞

–í `position_analyzer.py` (—Å—Ç—Ä–æ–∫–∏ ~169-170):
```python
size_threshold_far = 28   # –£–º–µ–Ω—å—à–∏—Ç–µ, –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ "–∑–∞ —Å–µ—Ç–∫–æ–π"
size_threshold_near = 48  # –£–≤–µ–ª–∏—á—å—Ç–µ, –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ "–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π"
```

### 2. –í–µ—Å–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤

–í `_analyze_depth_by_size()`:
```python
# –£–≤–µ–ª–∏—á—å—Ç–µ –≤–µ—Å —Ä–∞–∑–º–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
if ball_diameter < size_threshold_far:
    scores['behind'] += 0.6  # –±—ã–ª–æ 0.5

# –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ –≤–µ—Å Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
if normalized_y < y_threshold_high:
    scores['behind'] += 0.1  # –±—ã–ª–æ 0.2
```

### 3. –ü–æ—Ä–æ–≥ Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

```python
y_threshold_high = 0.5  # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 0.3-0.6
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç –Ω–∞ –æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
```bash
./analyze.sh datasets/merged_ball_dataset/images/test/test_000000.jpg
```

### –ü–∞–∫–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
```bash
for i in {0..9}; do
    img="datasets/merged_ball_dataset/images/test/test_$(printf "%06d" $i).jpg"
    ./analyze.sh "$img" 2>&1 | grep -E "(–†–∞–∑–º–µ—Ä|–†–ï–ó–£–õ–¨–¢–ê–¢)"
done
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–º–µ—Ä—ã –∑–∞ –≤–æ—Ä–æ—Ç–∞–º–∏**
   - –î–ª—è –∫–∞–º–µ—Ä—ã —Å–±–æ–∫—É –Ω—É–∂–Ω–∞ –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞

2. **–†–∞–∑–º–µ—Ä –º—è—á–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–ª–∏—á–∏–º**
   - –ü—Ä–∏ –Ω–∏–∑–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å

3. **–¢—Ä–µ–±—É–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞–º–µ—Ä—É**
   - –†–∞–∑–Ω—ã–µ –∫–∞–º–µ—Ä—ã/–æ–±—ä–µ–∫—Ç–∏–≤—ã ‚Üí —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö

4. **–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∞**
   - –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–µ–ª–µ–æ–±—ä–µ–∫—Ç–∏–≤–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö –º–µ–Ω—å—à–µ

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ | 44 |
| –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä | 22.5 px |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä | 72 px |
| –ú–µ–¥–∏–∞–Ω–∞ | 31.8 px |
| –†–∞–∑–±—Ä–æ—Å (std) | 15.0 px |

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
- 22-28 px (–∑–∞ —Å–µ—Ç–∫–æ–π): ~30%
- 28-48 px (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ): ~25%
- 48-72 px (–ø–µ—Ä–µ–¥ —Å–µ—Ç–∫–æ–π): ~20%

## –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. –ù–∞–π–¥–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å **–º–∞–ª–µ–Ω—å–∫–∏–º –º—è—á–æ–º** (20-25 px)
2. –ù–∞–π–¥–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å **–±–æ–ª—å—à–∏–º –º—è—á–æ–º** (55-70 px)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–æ–≥–∏—á–Ω—ã

```bash
# –ù–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫—Ä–∞–π–Ω–∏–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
.venv/bin/python calibrate_thresholds.py | grep -E "(22|23|70|71|72)"
```

---

**–†–µ–∑—é–º–µ:** –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **–≥–ª—É–±–∏–Ω—É –ø–æ —Ä–∞–∑–º–µ—Ä—É –º—è—á–∞**, –∞ –Ω–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ. –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –∫–∞–º–µ—Ä—ã –∑–∞ –≤–æ—Ä–æ—Ç–∞–º–∏.
